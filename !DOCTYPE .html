<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤§é˜ªåå¤å±‹æ—…éŠæ—¥è¨˜ | Osaka & Nagoya Diary</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        matcha: '#556B2F',
                        warm: '#FF7F50',
                        offwhite: '#F9F9F9',
                        dark: '#333333',
                        light: '#E5E5E5'
                    },
                    fontFamily: {
                        sans: ['Noto Sans TC', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #f0f2f5;
            /* éš±è—é è¨­æ²è»¸ä½†åœ¨å®¹å™¨å…§ä¿ç•™ */
        }
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        /* æ¨¡æ“¬æ‰‹æ©ŸAPPçš„éå ´å‹•ç•« */
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* AI é–ƒçˆå‹•ç•« */
        .ai-pulse {
            animation: pulse-glow 2s infinite;
        }
        @keyframes pulse-glow {
            0% { box-shadow: 0 0 0 0 rgba(85, 107, 47, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(85, 107, 47, 0); }
            100% { box-shadow: 0 0 0 0 rgba(85, 107, 47, 0); }
        }
    </style>
</head>
<body class="text-dark h-screen flex justify-center overflow-hidden">

    <div class="w-full md:w-[480px] lg:w-[500px] h-full bg-offwhite shadow-2xl flex flex-col relative overflow-hidden md:my-4 md:rounded-[40px] md:border-8 md:border-dark">
        
        <div class="h-8 bg-offwhite flex justify-between items-center px-6 pt-2 shrink-0 z-10">
            <span class="text-xs font-bold text-gray-400">09:41</span>
            <div class="flex gap-1">
                <div class="w-4 h-4 bg-gray-300 rounded-full"></div>
                <div class="w-4 h-4 bg-gray-300 rounded-full"></div>
            </div>
        </div>

        <main id="app-content" class="flex-1 overflow-y-auto p-5 pb-24 hide-scrollbar relative">
            </main>

        <nav class="h-20 bg-white border-t border-gray-100 flex justify-around items-center pb-2 shrink-0 absolute bottom-0 w-full z-20">
            <button onclick="router.navigate('home')" class="nav-btn flex flex-col items-center gap-1 text-gray-400 hover:text-matcha transition-colors" data-target="home">
                <i class="ph ph-house text-2xl"></i>
                <span class="text-[10px]">é¦–é </span>
            </button>
            <button onclick="router.navigate('schedule')" class="nav-btn flex flex-col items-center gap-1 text-gray-400 hover:text-matcha transition-colors" data-target="schedule">
                <i class="ph ph-calendar-check text-2xl"></i>
                <span class="text-[10px]">è¡Œç¨‹</span>
            </button>
            <button onclick="router.navigate('expenses')" class="nav-btn flex flex-col items-center gap-1 text-gray-400 hover:text-matcha transition-colors" data-target="expenses">
                <i class="ph ph-chart-pie-slice text-2xl"></i>
                <span class="text-[10px]">è¨˜å¸³</span>
            </button>
            <button onclick="router.navigate('album')" class="nav-btn flex flex-col items-center gap-1 text-gray-400 hover:text-matcha transition-colors" data-target="album">
                <i class="ph ph-images text-2xl"></i>
                <span class="text-[10px]">ç›¸ç°¿</span>
            </button>
            <button onclick="router.navigate('shopping')" class="nav-btn flex flex-col items-center gap-1 text-gray-400 hover:text-matcha transition-colors" data-target="shopping">
                <i class="ph ph-tag text-2xl"></i>
                <span class="text-[10px]">æ¯”åƒ¹</span>
            </button>
        </nav>

        <div id="modal-overlay" class="hidden absolute inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
            <div id="modal-content" class="bg-white w-full rounded-2xl p-6 shadow-xl transform transition-all scale-100 max-h-[85vh] overflow-y-auto">
                </div>
        </div>
    </div>

    <script>
        // --- 1. è³‡æ–™èˆ‡ç‹€æ…‹ç®¡ç† (State Management) ---
        const DEFAULT_STATE = {
            mood: 'excited',
            flightInfo: {
                depFlight: '', depDate: '', depTime: '',
                retFlight: '', retDate: '', retTime: ''
            },
            schedule: [
                { id: 1716000000000, date: 'Day 1', time: '14:00', location: 'åå¤å±‹åŸ', accommodation: 'åå¤å±‹è¬è±ª', mood: 'happy', notes: 'åˆ°äº†ï¼å¤©æ°£è¶…å¥½ï¼Œé°»é­šé£¯å¿…åƒã€‚', expenses: 5000 },
            ],
            products: [
                { id: 1, name: 'Panasonic å¹é¢¨æ©Ÿ', priceJP: 38000, priceTW: 10500 },
            ],
            photos: [] // å„²å­˜ Base64 (æ³¨æ„ï¼šLocalStorage æœ‰ 5MB é™åˆ¶ï¼Œå¯¦éš›å°ˆæ¡ˆå»ºè­°ä¸Šå‚³è‡³é›²ç«¯)
        };

        let appState = JSON.parse(localStorage.getItem('travelApp_v1')) || DEFAULT_STATE;

        const saveData = () => {
            try {
                localStorage.setItem('travelApp_v1', JSON.stringify(appState));
            } catch (e) {
                alert('å„²å­˜å¤±æ•—ï¼šè³‡æ–™é‡å¯èƒ½éå¤§ (LocalStorage é™åˆ¶)ã€‚å»ºè­°åˆªé™¤éƒ¨åˆ†ç…§ç‰‡ã€‚');
            }
        };

        // --- 2. å·¥å…·å‡½å¼ ---
        const $ = (selector) => document.querySelector(selector);
        const formatCurrency = (num) => num ? num.toLocaleString() : '0';
        
        // æ¨¡æ“¬ AI è«‹æ±‚ (AI Integration)
        const mockAICall = (prompt, type) => {
            return new Promise((resolve) => {
                setTimeout(() => {
                    let response = "";
                    if (type === 'schedule') {
                        response = `âœ¨ AI å»ºè­°ï¼šæ—¢ç„¶ä½ åœ¨${prompt}ï¼Œé™„è¿‘æœ‰å€‹éš±è—ç‰ˆç¥ç¤¾å¾ˆé©åˆæ‹ç…§ï¼å»ºè­°å¯ä»¥æŠŠæ™šé¤å®‰æ’åœ¨é“é “å €ï¼Œå˜—è©¦ç« é­šç‡’ã€‚é ç®—æ–¹é¢ï¼Œç›®å‰èŠ±è²»æ§åˆ¶å¾—å®œï¼Œå¯ä»¥å¤šè²·å€‹ç´€å¿µå“ã€‚`;
                    } else if (type === 'budget') {
                        response = `ğŸ’° AI åˆ†æï¼šä½ çš„è³¼ç‰©èŠ±è²»æ¯”ä¾‹è¼ƒé«˜ã€‚å»ºè­°æ¥ä¸‹ä¾†å¹¾å¤©å¤šå®‰æ’å…è²»æ™¯é»ï¼ˆå¦‚å…¬åœ’æ•£æ­¥ï¼‰ï¼Œä¸¦åˆ©ç”¨ä¸€æ—¥åˆ¸ç¯€çœäº¤é€šè²»ã€‚`;
                    } else if (type === 'diary') {
                        response = `ğŸ“ AI ç”Ÿæˆæ—¥è¨˜ï¼šä»Šå¤©åœ¨${prompt}çš„æ™‚å…‰çœŸæ˜¯å¤ªæ£’äº†ï¼é›–ç„¶è…³æœ‰é»é…¸ï¼Œä½†çœ‹åˆ°é‚£æ¨£çš„ç¾æ™¯ä¸€åˆ‡éƒ½å€¼å¾—ã€‚æ™šä¸Šçš„é¢¨å¾ˆæ¶¼çˆ½ï¼Œæ˜¯å€‹å®Œç¾çš„å¥é»ã€‚`;
                    }
                    resolve(response);
                }, 1500); // æ¨¡æ“¬ç¶²è·¯å»¶é²
            });
        };

        // --- 3. è·¯ç”±èˆ‡æ¸²æŸ“é‚è¼¯ ---
        const router = {
            currentPage: 'home',
            navigate(page) {
                this.currentPage = page;
                this.render();
                // æ›´æ–°å°èˆªç‹€æ…‹
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    if(btn.dataset.target === page) {
                        btn.classList.add('text-matcha');
                        btn.classList.remove('text-gray-400');
                    } else {
                        btn.classList.remove('text-matcha');
                        btn.classList.add('text-gray-400');
                    }
                });
            },
            render() {
                const content = $('#app-content');
                content.innerHTML = '';
                content.className = "flex-1 overflow-y-auto p-5 pb-24 hide-scrollbar relative fade-in"; // é‡ç½®å‹•ç•«

                switch(this.currentPage) {
                    case 'home': renderHome(content); break;
                    case 'schedule': renderSchedule(content); break;
                    case 'expenses': renderExpenses(content); break;
                    case 'album': renderAlbum(content); break;
                    case 'shopping': renderShopping(content); break;
                }
            }
        };

        // --- 4. é é¢æ¸²æŸ“å‡½å¼ ---

        /* === é¦–é  (Home) === */
        function renderHome(container) {
            const { flightInfo, mood } = appState;
            
            const moodIcons = {
                happy: 'ğŸ˜Š é–‹å¿ƒ', excited: 'ğŸ¤© èˆˆå¥®', relaxed: 'ğŸ˜Œ æ”¾é¬†', tired: 'ğŸ˜« ç´¯äº†'
            };

            container.innerHTML = `
                <div class="space-y-6">
                    <header>
                        <h1 class="text-3xl font-bold text-dark">é—œè¥¿ â€¢ ä¸­éƒ¨ä¹‹æ—…</h1>
                        <p class="text-gray-400 tracking-widest text-sm mt-1">OSAKA & NAGOYA DIARY</p>
                    </header>

                    <div class="bg-white p-5 rounded-2xl shadow-sm border-l-4 border-matcha relative">
                        <button onclick="editFlightInfo()" class="absolute top-4 right-4 text-gray-400 hover:text-dark"><i class="ph ph-pencil-simple"></i></button>
                        <div class="flex items-center gap-2 mb-4 text-matcha">
                            <i class="ph ph-airplane-tilt text-xl"></i>
                            <span class="font-bold text-lg">èˆªç­è³‡è¨Š</span>
                        </div>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <p class="text-xs text-gray-400 mb-1">å»ç¨‹ (${flightInfo.depFlight || '-'})</p>
                                <p class="font-medium">${flightInfo.depDate || 'æœªè¨­å®š'} ${flightInfo.depTime || ''}</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-400 mb-1">å›ç¨‹ (${flightInfo.retFlight || '-'})</p>
                                <p class="font-medium">${flightInfo.retDate || 'æœªè¨­å®š'} ${flightInfo.retTime || ''}</p>
                            </div>
                        </div>
                    </div>

                    <div>
                        <h2 class="text-lg font-bold text-dark mb-3">ä»Šæ—¥å¿ƒæƒ…</h2>
                        <div class="grid grid-cols-4 gap-3">
                            ${Object.entries(moodIcons).map(([key, label]) => `
                                <button onclick="setMood('${key}')" 
                                    class="flex flex-col items-center justify-center p-3 rounded-2xl transition-all ${mood === key ? 'bg-matcha text-white shadow-lg scale-105' : 'bg-white text-gray-500'}">
                                    <span class="text-2xl mb-1">${label.split(' ')[0]}</span>
                                    <span class="text-xs">${label.split(' ')[1]}</span>
                                </button>
                            `).join('')}
                        </div>
                    </div>

                    <div class="rounded-2xl overflow-hidden h-48 relative shadow-md group">
                        <img src="https://images.unsplash.com/photo-1590559374747-9c0861618062?auto=format&fit=crop&w=800&q=80" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110" alt="Osaka">
                        <div class="absolute inset-0 bg-black/30 flex items-center justify-center">
                            <span class="text-white font-bold text-2xl tracking-widest border-2 border-white px-4 py-2">JAPAN 2025</span>
                        </div>
                    </div>
                </div>
            `;
        }

        /* === è¡Œç¨‹ (Schedule) === */
        function renderSchedule(container) {
            container.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-2xl font-bold text-dark">è¡Œç¨‹è¡¨</h1>
                    <button onclick="openScheduleModal()" class="bg-dark text-white w-10 h-10 rounded-full shadow-lg flex items-center justify-center hover:bg-matcha transition-colors">
                        <i class="ph ph-plus text-xl"></i>
                    </button>
                </div>
                
                <div class="space-y-6">
                    ${appState.schedule.length === 0 ? '<p class="text-center text-gray-400 mt-10">å°šç„¡è¡Œç¨‹ï¼Œé»æ“Š + æ–°å¢</p>' : ''}
                    ${appState.schedule.sort((a,b) => a.date.localeCompare(b.date)).map(item => `
                        <div class="flex relative group">
                            <div class="flex flex-col items-center mr-4 w-12 pt-1 shrink-0">
                                <span class="font-bold text-matcha text-sm">${item.date}</span>
                                <span class="text-xs text-gray-400">${item.time}</span>
                                <div class="w-[1px] h-full bg-gray-200 mt-2 group-last:hidden"></div>
                            </div>
                            
                            <div class="flex-1 bg-white p-4 rounded-xl shadow-sm border border-gray-100 mb-2 relative overflow-hidden">
                                <div class="absolute top-0 left-0 w-1 h-full ${item.mood === 'happy' ? 'bg-yellow-400' : 'bg-matcha'}"></div>
                                <div class="flex justify-between items-start mb-2 pl-2">
                                    <h3 class="font-bold text-dark text-lg">${item.location}</h3>
                                    <div class="flex gap-2">
                                        <button onclick="aiSuggest('${item.location}', 'schedule')" class="text-matcha bg-matcha/10 px-2 py-1 rounded-full text-xs flex items-center gap-1 hover:bg-matcha hover:text-white transition-colors">
                                            <i class="ph ph-sparkle"></i> AI
                                        </button>
                                        <button onclick="deleteSchedule(${item.id})" class="text-gray-300 hover:text-red-400"><i class="ph ph-trash"></i></button>
                                    </div>
                                </div>
                                <p class="text-gray-600 text-sm mb-3 pl-2">${item.notes || 'æš«ç„¡ç­†è¨˜'}</p>
                                
                                <div class="flex flex-wrap gap-2 pl-2">
                                    ${item.accommodation ? `
                                        <span class="bg-gray-100 text-gray-600 text-xs px-2 py-1 rounded flex items-center gap-1">
                                            <i class="ph ph-bed"></i> ${item.accommodation}
                                        </span>
                                    ` : ''}
                                    ${item.expenses ? `
                                        <span class="bg-warm/10 text-warm text-xs px-2 py-1 rounded flex items-center gap-1">
                                            <i class="ph ph-money"></i> Â¥${item.expenses}
                                        </span>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        /* === è¨˜å¸³ (Expenses) === */
        function renderExpenses(container) {
            // è¨ˆç®—ç¸½èŠ±è²»
            const total = appState.schedule.reduce((sum, item) => sum + (Number(item.expenses) || 0), 0);
            
            // æº–å‚™åœ–è¡¨è³‡æ–™ (ä¾åœ°é»åˆ†é¡)
            const labels = appState.schedule.map(i => i.location);
            const data = appState.schedule.map(i => i.expenses || 0);

            container.innerHTML = `
                <div class="mb-6">
                    <h1 class="text-2xl font-bold text-dark">æ—…è²»è¿½è¹¤</h1>
                    <p class="text-gray-500 text-sm">ç¸½æ”¯å‡º: <span class="text-warm font-bold text-xl">Â¥${formatCurrency(total)}</span></p>
                </div>

                <div class="bg-white p-4 rounded-2xl shadow-sm mb-6 h-64">
                    <canvas id="expenseChart"></canvas>
                </div>

                <div class="bg-matcha/10 p-4 rounded-xl border border-matcha/20 mb-6">
                    <div class="flex items-start gap-3">
                        <i class="ph ph-robot text-2xl text-matcha ai-pulse"></i>
                        <div>
                            <h3 class="font-bold text-matcha mb-1">AI è²¡å‹™é¡§å•</h3>
                            <p class="text-xs text-dark/70 mb-2">é»æ“Šåˆ†æç›®å‰çš„æ”¯å‡ºç‹€æ³ä¸¦ç²å¾—å»ºè­°ã€‚</p>
                            <button onclick="aiSuggest('æ•´é«”è¡Œç¨‹', 'budget')" class="bg-matcha text-white text-xs px-3 py-1.5 rounded-lg shadow-sm hover:bg-opacity-90">åˆ†æé ç®—</button>
                        </div>
                    </div>
                </div>

                <div class="space-y-3">
                    <h3 class="font-bold text-dark">æ”¯å‡ºæ˜ç´°</h3>
                    ${appState.schedule.filter(i => i.expenses > 0).map(item => `
                        <div class="flex justify-between items-center bg-white p-3 rounded-lg border-b border-gray-50">
                            <div>
                                <span class="text-sm font-medium text-dark block">${item.location}</span>
                                <span class="text-xs text-gray-400">${item.date}</span>
                            </div>
                            <span class="font-bold text-dark">Â¥${formatCurrency(item.expenses)}</span>
                        </div>
                    `).join('')}
                </div>
            `;

            // ç¹ªè£½åœ–è¡¨
            setTimeout(() => {
                const ctx = document.getElementById('expenseChart');
                if(ctx) {
                    new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'èŠ±è²» (æ—¥åœ“)',
                                data: data,
                                backgroundColor: '#FF7F50',
                                borderRadius: 4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: { y: { beginAtZero: true } }
                        }
                    });
                }
            }, 100);
        }

        /* === ç›¸ç°¿ (Album) === */
        function renderAlbum(container) {
            container.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-2xl font-bold text-dark">æ—…é€”ç›¸ç°¿</h1>
                    <label class="bg-dark text-white w-10 h-10 rounded-full shadow-lg flex items-center justify-center cursor-pointer hover:bg-matcha transition-colors">
                        <i class="ph ph-upload-simple text-xl"></i>
                        <input type="file" accept="image/*" class="hidden" onchange="handlePhotoUpload(this)">
                    </label>
                </div>

                <div class="grid grid-cols-2 gap-3 pb-20">
                    ${appState.photos.map(photo => `
                        <div onclick="openPhotoModal('${photo.uri}', '${photo.location}', '${photo.desc}')" class="relative aspect-square rounded-xl overflow-hidden cursor-pointer group shadow-sm bg-gray-200">
                            <img src="${photo.uri}" class="w-full h-full object-cover transition duration-500 group-hover:scale-110">
                            <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/60 to-transparent p-2 pt-6">
                                <p class="text-white text-xs font-bold truncate"><i class="ph ph-map-pin mr-1"></i>${photo.location}</p>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        /* === æ¯”åƒ¹ (Shopping) === */
        function renderShopping(container) {
            container.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-2xl font-bold text-dark">æ¯”åƒ¹æ¸…å–®</h1>
                </div>

                <div class="bg-white p-5 rounded-2xl shadow-sm mb-6">
                    <h3 class="font-bold text-sm mb-3">æ–°å¢å•†å“</h3>
                    <input id="prodName" placeholder="å•†å“åç¨±" class="w-full bg-gray-50 p-2 rounded mb-2 border border-gray-100 text-sm">
                    <div class="flex gap-2 mb-2">
                        <input id="prodPriceJP" type="number" placeholder="æ—¥å¹£ Â¥" class="w-1/2 bg-gray-50 p-2 rounded border border-gray-100 text-sm">
                        <input id="prodPriceTW" type="number" placeholder="å°å¹£ $" class="w-1/2 bg-gray-50 p-2 rounded border border-gray-100 text-sm">
                    </div>
                    <button onclick="addProduct()" class="w-full bg-dark text-white py-2 rounded-lg text-sm hover:bg-matcha transition-colors">åŠ å…¥æ¸…å–®</button>
                </div>

                <div class="space-y-3">
                    ${appState.products.map(item => `
                        <div class="bg-white p-4 rounded-xl shadow-sm flex items-center justify-between">
                            <div>
                                <h3 class="font-bold text-dark mb-1">${item.name}</h3>
                                <div class="text-sm space-y-1">
                                    <p class="text-gray-500">ğŸ‡¯ğŸ‡µ Â¥${item.priceJP ? item.priceJP.toLocaleString() : 'å°šç„¡åƒ¹æ ¼'}</p>
                                    <p class="text-gray-500">ğŸ‡¹ğŸ‡¼ $${item.priceTW ? item.priceTW.toLocaleString() : 'å°šç„¡åƒ¹æ ¼'}</p>
                                </div>
                            </div>
                            <div class="text-right">
                                ${item.priceJP && item.priceTW ? `
                                    <span class="text-xs bg-gray-100 px-2 py-1 rounded text-gray-500">åŒ¯ç‡ç´„ 0.22</span>
                                    <p class="text-xs mt-1 ${ (item.priceJP * 0.22) < item.priceTW ? 'text-matcha font-bold' : 'text-red-500' }">
                                        ${ (item.priceJP * 0.22) < item.priceTW ? 'æ—¥æœ¬ä¾¿å®œ' : 'å°ç£ä¾¿å®œ' }
                                    </p>
                                ` : ''}
                                <button onclick="deleteProduct(${item.id})" class="text-gray-300 hover:text-red-400 mt-2 block ml-auto"><i class="ph ph-trash"></i></button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // --- 5. äº’å‹•é‚è¼¯èˆ‡ Modal æ§åˆ¶ ---

        const modal = {
            overlay: $('#modal-overlay'),
            content: $('#modal-content'),
            open(html) {
                this.content.innerHTML = html;
                this.overlay.classList.remove('hidden');
            },
            close() {
                this.overlay.classList.add('hidden');
            }
        };

        // é»æ“Šé®ç½©é—œé–‰ Modal
        $('#modal-overlay').addEventListener('click', (e) => {
            if (e.target.id === 'modal-overlay') modal.close();
        });

        // è¨­å®šå¿ƒæƒ…
        function setMood(mood) {
            appState.mood = mood;
            saveData();
            renderHome($('#app-content'));
        }

        // ç·¨è¼¯èˆªç­
        function editFlightInfo() {
            const { flightInfo } = appState;
            modal.open(`
                <h2 class="text-xl font-bold mb-4">ç·¨è¼¯èˆªç­</h2>
                <div class="space-y-4">
                    <div>
                        <label class="text-xs text-gray-500 font-bold block mb-1">å»ç¨‹è³‡è¨Š</label>
                        <input id="f_dep_no" value="${flightInfo.depFlight}" placeholder="èˆªç­è™Ÿç¢¼" class="w-full border p-2 rounded mb-2 text-sm">
                        <div class="flex gap-2">
                            <input id="f_dep_date" value="${flightInfo.depDate}" placeholder="æ—¥æœŸ" class="w-2/3 border p-2 rounded text-sm">
                            <input id="f_dep_time" value="${flightInfo.depTime}" placeholder="æ™‚é–“" class="w-1/3 border p-2 rounded text-sm">
                        </div>
                    </div>
                    <div>
                        <label class="text-xs text-gray-500 font-bold block mb-1">å›ç¨‹è³‡è¨Š</label>
                        <input id="f_ret_no" value="${flightInfo.retFlight}" placeholder="èˆªç­è™Ÿç¢¼" class="w-full border p-2 rounded mb-2 text-sm">
                        <div class="flex gap-2">
                            <input id="f_ret_date" value="${flightInfo.retDate}" placeholder="æ—¥æœŸ" class="w-2/3 border p-2 rounded text-sm">
                            <input id="f_ret_time" value="${flightInfo.retTime}" placeholder="æ™‚é–“" class="w-1/3 border p-2 rounded text-sm">
                        </div>
                    </div>
                    <button onclick="saveFlightInfo()" class="w-full bg-matcha text-white py-3 rounded-lg font-bold mt-2">å„²å­˜</button>
                </div>
            `);
        }

        function saveFlightInfo() {
            appState.flightInfo = {
                depFlight: $('#f_dep_no').value, depDate: $('#f_dep_date').value, depTime: $('#f_dep_time').value,
                retFlight: $('#f_ret_no').value, retDate: $('#f_ret_date').value, retTime: $('#f_ret_time').value,
            };
            saveData();
            modal.close();
            renderHome($('#app-content'));
        }

        // è¡Œç¨‹ Modal
        function openScheduleModal() {
            modal.open(`
                <h2 class="text-xl font-bold mb-4">æ–°å¢è¡Œç¨‹</h2>
                <div class="space-y-3">
                    <input id="sch_date" placeholder="æ—¥æœŸ (e.g. Day 1)" class="w-full bg-gray-50 p-3 rounded-lg outline-none text-sm">
                    <input id="sch_time" placeholder="æ™‚é–“ (e.g. 14:00)" class="w-full bg-gray-50 p-3 rounded-lg outline-none text-sm">
                    <input id="sch_loc" placeholder="åœ°é»" class="w-full bg-gray-50 p-3 rounded-lg outline-none text-sm border-l-4 border-warm">
                    <input id="sch_acc" placeholder="ä½å®¿è³‡è¨Š (é¸å¡«)" class="w-full bg-gray-50 p-3 rounded-lg outline-none text-sm">
                    <input id="sch_exp" type="number" placeholder="é ä¼°èŠ±è²» Â¥ (é¸å¡«)" class="w-full bg-gray-50 p-3 rounded-lg outline-none text-sm">
                    <textarea id="sch_note" rows="3" placeholder="ç­†è¨˜ / å¿ƒæƒ…" class="w-full bg-gray-50 p-3 rounded-lg outline-none text-sm resize-none"></textarea>
                    
                    <div class="flex gap-2 text-sm justify-center py-2">
                        <label class="cursor-pointer"><input type="radio" name="mood" value="happy" checked> ğŸ˜Š</label>
                        <label class="cursor-pointer"><input type="radio" name="mood" value="excited"> ğŸ¤©</label>
                        <label class="cursor-pointer"><input type="radio" name="mood" value="relaxed"> ğŸ˜Œ</label>
                        <label class="cursor-pointer"><input type="radio" name="mood" value="tired"> ğŸ˜«</label>
                    </div>

                    <button onclick="addSchedule()" class="w-full bg-dark text-white py-3 rounded-lg font-bold">æ–°å¢</button>
                </div>
            `);
        }

        function addSchedule() {
            const loc = $('#sch_loc').value;
            if(!loc) return alert('è«‹è¼¸å…¥åœ°é»');
            
            const newItem = {
                id: Date.now(),
                date: $('#sch_date').value,
                time: $('#sch_time').value,
                location: loc,
                accommodation: $('#sch_acc').value,
                expenses: parseInt($('#sch_exp').value) || 0,
                notes: $('#sch_note').value,
                mood: document.querySelector('input[name="mood"]:checked').value
            };
            
            appState.schedule.push(newItem);
            saveData();
            modal.close();
            renderSchedule($('#app-content'));
        }

        function deleteSchedule(id) {
            if(confirm('ç¢ºå®šåˆªé™¤æ­¤è¡Œç¨‹ï¼Ÿ')) {
                appState.schedule = appState.schedule.filter(i => i.id !== id);
                saveData();
                renderSchedule($('#app-content'));
            }
        }

        // æ¯”åƒ¹é‚è¼¯
        function addProduct() {
            const name = $('#prodName').value;
            if(!name) return;
            appState.products.push({
                id: Date.now(),
                name: name,
                priceJP: parseFloat($('#prodPriceJP').value) || null,
                priceTW: parseFloat($('#prodPriceTW').value) || null
            });
            saveData();
            renderShopping($('#app-content'));
        }
        function deleteProduct(id) {
            appState.products = appState.products.filter(i => i.id !== id);
            saveData();
            renderShopping($('#app-content'));
        }

        // ç›¸ç‰‡ä¸Šå‚³ (Base64)
        function handlePhotoUpload(input) {
            const file = input.files[0];
            if (!file) return;
            
            // ç°¡å–®æª¢æŸ¥å¤§å° (é™åˆ¶ 2MB é¿å… localStorage çˆ†æ‰)
            if (file.size > 2 * 1024 * 1024) {
                alert('åœ–ç‰‡éå¤§ï¼ç‚ºäº†ç¢ºä¿ç¶²é é‹ä½œé †æš¢ï¼Œè«‹ä¸Šå‚³å°æ–¼ 2MB çš„ç…§ç‰‡ã€‚');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const location = prompt('é€™æ˜¯å“ªè£¡æ‹çš„ï¼Ÿ', 'å¤§é˜ª');
                if(!location) return;

                appState.photos.unshift({
                    id: Date.now(),
                    uri: e.target.result,
                    location: location,
                    desc: 'æ–°å¢çš„ç…§ç‰‡'
                });
                saveData();
                renderAlbum($('#app-content'));
            };
            reader.readAsDataURL(file);
        }

        function openPhotoModal(uri, loc, desc) {
            modal.open(`
                <div class="text-center">
                    <img src="${uri}" class="max-h-[60vh] mx-auto rounded-lg shadow-lg mb-4">
                    <h3 class="text-xl font-bold text-dark">${loc}</h3>
                    <p class="text-gray-500 text-sm mt-1">${desc}</p>
                    <button onclick="modal.close()" class="mt-4 text-gray-400 border border-gray-300 px-4 py-1 rounded-full text-sm">é—œé–‰</button>
                </div>
            `);
        }

        // AI æ•´åˆåŠŸèƒ½
        async function aiSuggest(context, type) {
            // é¡¯ç¤º Loading
            const btn = event.currentTarget;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="ph ph-spinner animate-spin"></i> åˆ†æä¸­...';
            btn.disabled = true;

            const suggestion = await mockAICall(context, type);

            modal.open(`
                <div class="text-center p-2">
                    <div class="w-12 h-12 bg-matcha/10 rounded-full flex items-center justify-center mx-auto mb-3">
                        <i class="ph ph-robot text-2xl text-matcha"></i>
                    </div>
                    <h3 class="font-bold text-lg mb-2">AI åŠ©æ‰‹å»ºè­°</h3>
                    <p class="text-gray-600 leading-relaxed text-left bg-gray-50 p-4 rounded-xl text-sm">
                        ${suggestion}
                    </p>
                    <div class="mt-4 flex gap-2 justify-center">
                         ${type === 'diary' ? '<button class="bg-matcha text-white px-4 py-2 rounded-lg text-sm">è¤‡è£½åˆ°ç­†è¨˜</button>' : ''}
                        <button onclick="modal.close()" class="text-gray-500 px-4 py-2 text-sm">é—œé–‰</button>
                    </div>
                </div>
            `);

            // æ¢å¾©æŒ‰éˆ•
            btn.innerHTML = originalText;
            btn.disabled = false;
        }

        // åˆå§‹åŒ–
        router.render();

    </script>
</body>
</html>